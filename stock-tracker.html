<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StockVue Elite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@0.1.1/dist/chartjs-chart-financial.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Roboto+Slab:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
    <style>
        :root {
            --primary-color: #0ea5e9;
            --primary-light: #38bdf8;
            --primary-dark: #0284c7;
            --success-color: #10b981;
            --success-light: #34d399;
            --success-dark: #059669;
            --danger-color: #ef4444;
            --danger-light: #f87171;
            --danger-dark: #dc2626;
            --accent-color: #f59e0b;
            --accent-light: #fbbf24;
            --accent-dark: #d97706;
            
            --card-bg: #1e293b;
            --card-bg-lighter: #334155;
            --bg-color: #0f172a;
            --bg-color-lighter: #1e293b;
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --text-tertiary: #94a3b8;
            --border-color: rgba(255, 255, 255, 0.08);
            
            --glass-bg: rgba(30, 41, 59, 0.8);
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            --glass-blur: 10px;
        }
        
        :root.light-mode {
            --primary-color: #0ea5e9;
            --primary-light: #38bdf8;
            --primary-dark: #0284c7;
            --success-color: #10b981;
            --success-light: #34d399;
            --success-dark: #059669;
            --danger-color: #ef4444;
            --danger-light: #f87171;
            --danger-dark: #dc2626;
            --accent-color: #f59e0b;
            --accent-light: #fbbf24;
            --accent-dark: #d97706;
            
            --card-bg: #f1f5f9;
            --card-bg-lighter: #e2e8f0;
            --bg-color: #ffffff;
            --bg-color-lighter: #f8fafc;
            --text-primary: #0f172a;
            --text-secondary: #334155;
            --text-tertiary: #64748b;
            --border-color: rgba(0, 0, 0, 0.08);
            
            --glass-bg: rgba(241, 245, 249, 0.8);
            --glass-border: rgba(0, 0, 0, 0.1);
            --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            --glass-blur: 10px;
        }
        
        /* Additional light mode styles */
        :root.light-mode .glass-card {
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        :root.light-mode .sidebar-item:not(.active) {
            color: var(--text-secondary);
        }
        
        :root.light-mode .sidebar-item.active {
            background-color: rgba(14, 165, 233, 0.2);
            color: var(--primary-color);
        }
        
        :root.light-mode .time-range-btn:not(.active) {
            color: var(--text-secondary);
        }
        
        :root.light-mode .time-range-btn.active {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
        }
        
        :root.light-mode .btn-primary {
            color: white;
        }
        
        :root.light-mode .btn-secondary {
            background-color: rgba(0, 0, 0, 0.05);
            color: var(--text-secondary);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        :root.light-mode .btn-secondary:hover {
            background-color: rgba(0, 0, 0, 0.1);
            color: var(--text-primary);
        }
        
        :root.light-mode .tooltip {
            background-color: var(--card-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        
        :root.light-mode ::-webkit-scrollbar-track {
            background: rgba(241, 245, 249, 0.6);
        }
        
        :root.light-mode .news-item:hover {
            background-color: rgba(0, 0, 0, 0.02);
        }
        
        :root.light-mode .stock-card:hover {
            box-shadow: 0 15px 30px -5px rgba(0, 0, 0, 0.2);
        }
        
        :root.light-mode #stockSearch {
            background-color: var(--card-bg-lighter);
            color: var(--text-primary);
            border-color: var(--border-color);
        }
        
        :root.light-mode .bg-slate-800 {
            background-color: var(--card-bg-lighter);
        }
        
        :root.light-mode .text-white {
            color: var(--text-primary);
        }
        
        :root.light-mode .text-gray-400 {
            color: var(--text-secondary);
        }
        
        :root.light-mode .hover\:bg-slate-700:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }
        
        :root.light-mode input.bg-slate-800 {
            background-color: var(--card-bg-lighter);
            color: var(--text-primary);
            border-color: var(--border-color);
        }
        
        :root.light-mode .text-gray-300 {
            color: var(--text-secondary);
        }
        
        :root.light-mode table.bg-slate-800 {
            background-color: var(--card-bg-lighter);
        }
        
        :root.light-mode table th.text-gray-400 {
            color: var(--text-secondary);
        }
        
        :root.light-mode table td.text-white {
            color: var(--text-primary);
        }
        
        :root.light-mode .divide-slate-700 > * {
            border-color: rgba(0, 0, 0, 0.1);
        }
        
        :root.light-mode .hover\:bg-slate-700:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }
        
        :root.light-mode footer {
            background: linear-gradient(to right, var(--card-bg), var(--card-bg-lighter));
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(14, 165, 233, 0.05) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(16, 185, 129, 0.05) 0%, transparent 20%),
                radial-gradient(circle at 50% 50%, rgba(245, 158, 11, 0.03) 0%, transparent 40%);
            background-attachment: fixed;
        }
        
        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
            border: 1px solid var(--glass-border);
            box-shadow: var(--glass-shadow);
            border-radius: 16px;
            position: relative;
            overflow: hidden;
        }
        
        .stock-card {
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            border-left: 4px solid transparent;
            background: var(--card-bg);
            border-radius: 12px;
            position: relative;
            overflow: hidden;
        }
        
        .stock-card:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 15px 30px -5px rgba(0, 0, 0, 0.4);
        }
        
        .stock-card.positive {
            border-left-color: var(--success-color);
        }
        
        .stock-card.negative {
            border-left-color: var(--danger-color);
        }
        
        .positive {
            color: var(--success-light);
        }
        
        .negative {
            color: var(--danger-light);
        }
        
        .shimmer {
            background: linear-gradient(90deg, rgba(30, 41, 59, 0.5) 25%, rgba(51, 65, 85, 0.5) 50%, rgba(30, 41, 59, 0.5) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.8s infinite;
            border-radius: 8px;
        }
        
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary-color));
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(14, 165, 233, 0.4);
        }
        
        .btn-secondary {
            background-color: rgba(255, 255, 255, 0.05);
            color: var(--text-secondary);
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(5px);
        }
        
        .btn-secondary:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }
        
        .btn-accent {
            background: linear-gradient(135deg, var(--accent-color), var(--accent-dark));
            color: #fff;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .btn-accent:hover {
            background: linear-gradient(135deg, var(--accent-light), var(--accent-color));
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(245, 158, 11, 0.4);
        }
        
        .time-range-btn, .chart-type-btn {
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.05);
            background: rgba(255, 255, 255, 0.02);
            color: var(--text-tertiary);
        }
        
        .time-range-btn.active, .chart-type-btn.active {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
        }
        
        .time-range-btn:hover:not(.active), .chart-type-btn:hover:not(.active) {
            background-color: rgba(255, 255, 255, 0.05);
            color: var(--text-secondary);
        }
        
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(15, 23, 42, 0.6);
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(var(--primary-dark), var(--primary-color));
            border-radius: 10px;
        }
        
        @keyframes ticker {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }
        
        .ticker-content {
            animation: ticker 60s linear infinite;
        }
        
        .tooltip {
            position: absolute;
            left: 100%;
            top: 50%;
            transform: translateY(-50%);
            background: var(--card-bg);
            color: var(--text-primary);
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.75rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s ease;
            margin-left: 0.75rem;
            z-index: 100;
            border: 1px solid var(--glass-border);
        }
        
        .tooltip-container:hover .tooltip {
            opacity: 1;
        }

        .sidebar-item {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .sidebar-item.active {
            background-color: rgba(59, 130, 246, 0.2);
        }

        .news-item {
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .news-item:hover {
            background-color: rgba(255, 255, 255, 0.02);
            transform: translateX(4px);
        }

        .section-hidden {
            display: none;
        }
        
        /* Theme Toggle Switch */
        .theme-toggle-wrapper {
            position: relative;
            display: inline-block;
        }
        
        .theme-toggle {
            display: inline-block;
            cursor: pointer;
        }
        
        .theme-toggle-input {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .theme-toggle-track {
            position: relative;
            display: inline-block;
            width: 52px;
            height: 28px;
            background-color: var(--card-bg-lighter);
            border-radius: 34px;
            transition: all 0.3s ease;
            border: 1px solid var(--border-color);
        }
        
        .theme-toggle-thumb {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 22px;
            height: 22px;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            border-radius: 50%;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
        }
        
        .theme-toggle-input:checked + .theme-toggle-track .theme-toggle-thumb {
            transform: translateX(24px);
            background: linear-gradient(135deg, var(--accent-color), var(--accent-dark));
        }
        
        .dark-icon, .light-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            transition: opacity 0.3s ease;
        }
        
        .light-icon {
            opacity: 0;
        }
        
        .theme-toggle-input:checked + .theme-toggle-track .dark-icon {
            opacity: 0;
        }
        
        .theme-toggle-input:checked + .theme-toggle-track .light-icon {
            opacity: 1;
        }
    </style>
</head>
<body class="animate__animated animate__fadeIn">
    <div class="min-h-screen">
        <!-- Ticker -->
        <div class="bg-black py-2 overflow-hidden">
            <div class="ticker-content flex items-center space-x-8 whitespace-nowrap">
                <div class="flex items-center">
                     
                    <span class="text-amber-400 font-medium mr-2">S&P 500</span>
                    <span class="text-green-400 font-semibold">4,783.35</span>
                    <span class="text-green-400 text-xs ml-1">+0.42%</span>
                </div>
                <div class="flex items-center">
                    <span class="text-amber-400 font-medium mr-2">NASDAQ</span>
                    <span class="text-green-400 font-semibold">16,742.39</span>
                    <span class="text-green-400 text-xs ml-1">+0.71%</span>
                </div>
                <div class="flex items-center">
                    <span class="text-amber-400 font-medium mr-2">DOW</span>
                    <span class="text-red-400 font-semibold">38,671.69</span>
                    <span class="text-red-400 text-xs ml-1">-0.13%</span>
                </div>
                <div class="flex items-center">
                    <span class="text-amber-400 font-medium mr-2">NIFTY</span>
                    <span class="text-green-400 font-semibold">22,055.70</span>
                    <span class="text-green-400 text-xs ml-1">+0.28%</span>
                </div>
                <div class="flex items-center">
                    <span class="text-amber-400 font-medium mr-2">BTC-USD</span>
                    <span class="text-green-400 font-semibold">63,245.78</span>
                    <span class="text-green-400 text-xs ml-1">+2.14%</span>
                </div>
            </div>
        </div>
        
        <!-- Header -->
        <header class="glass-card text-white py-8 shadow-lg relative overflow-hidden mx-4 mt-4">
            <div class="container mx-auto px-4">
                <div class="flex flex-col md:flex-row justify-between items-center">
                    <div class="flex items-center mb-6 md:mb-0">
                        <div class="mr-4 bg-blue-500 bg-opacity-20 p-3 rounded-lg">
                            <i class="fas fa-chart-line text-2xl text-blue-400"></i>
                        </div>
                        <div>
                            <h1 class="text-3xl font-bold bg-gradient-to-r from-blue-400 to-amber-400 bg-clip-text text-transparent">
                                StockVue Elite
                            </h1>
                            <p class="text-blue-300 text-sm font-light tracking-wider">PREMIUM MARKET INTELLIGENCE</p>
                        </div>
                    </div>
                    
                    <div class="flex items-center justify-between w-full md:w-2/5">
                        <div class="relative flex-grow mr-4">
                            <input id="stockSearch" type="text" placeholder="Search any company worldwide (e.g., Apple, Tesla)" 
                                class="w-full py-3 px-5 rounded-lg bg-slate-800 text-white border border-slate-600 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                list="stockSuggestions" autocomplete="off">
                            <datalist id="stockSuggestions">
                                <!-- Stock suggestions will be populated dynamically -->
                            </datalist>
                            <button id="searchButton" class="absolute right-0 top-0 h-full px-5 bg-gradient-to-r from-blue-600 to-blue-500 text-white rounded-r-lg hover:from-blue-500 hover:to-blue-400 transition-all duration-300 flex items-center">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                        <div class="theme-toggle-wrapper">
                            <label class="theme-toggle" for="themeToggle">
                                <input type="checkbox" id="themeToggle" class="theme-toggle-input">
                                <div class="theme-toggle-track">
                                    <div class="theme-toggle-thumb">
                                        <i class="fas fa-moon dark-icon"></i>
                                        <i class="fas fa-sun light-icon"></i>
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- Quick access panels -->
                <div class="mt-8 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-3">
                    <div class="glass-card p-3 rounded-lg cursor-pointer hover:shadow-lg transition-all duration-300 transform hover:scale-105" data-symbol="AAPL">
                        <div class="flex justify-between items-center">
                            <span class="font-medium text-sm">AAPL</span>
                            <span class="text-green-400 text-xs">+1.2%</span>
                        </div>
                        <div class="text-lg font-bold mt-1">$175.34</div>
                    </div>
                    <div class="glass-card p-3 rounded-lg cursor-pointer hover:shadow-lg transition-all duration-300 transform hover:scale-105" data-symbol="MSFT">
                        <div class="flex justify-between items-center">
                            <span class="font-medium text-sm">MSFT</span>
                            <span class="text-green-400 text-xs">+0.8%</span>
                        </div>
                        <div class="text-lg font-bold mt-1">$415.22</div>
                    </div>
                    <div class="glass-card p-3 rounded-lg cursor-pointer hover:shadow-lg transition-all duration-300 transform hover:scale-105" data-symbol="GOOGL">
                        <div class="flex justify-between items-center">
                            <span class="font-medium text-sm">GOOGL</span>
                            <span class="text-red-400 text-xs">-0.5%</span>
                        </div>
                        <div class="text-lg font-bold mt-1">$142.38</div>
                    </div>
                    <div class="glass-card p-3 rounded-lg cursor-pointer hover:shadow-lg transition-all duration-300 transform hover:scale-105" data-symbol="AMZN">
                        <div class="flex justify-between items-center">
                            <span class="font-medium text-sm">AMZN</span>
                            <span class="text-green-400 text-xs">+1.5%</span>
                        </div>
                        <div class="text-lg font-bold mt-1">$178.92</div>
                    </div>
                    <div class="glass-card p-3 rounded-lg cursor-pointer hover:shadow-lg transition-all duration-300 transform hover:scale-105" data-symbol="TSLA">
                        <div class="flex justify-between items-center">
                            <span class="font-medium text-sm">TSLA</span>
                            <span class="text-red-400 text-xs">-2.1%</span>
                        </div>
                        <div class="text-lg font-bold mt-1">$240.76</div>
                    </div>
                </div>
            </div>
        </header>

        <main class="container mx-auto px-4 py-8">
            <!-- Sidebar Navigation -->
            <div class="fixed left-4 top-1/2 transform -translate-y-1/2 w-16 bg-slate-800 z-50 flex flex-col items-center py-8 rounded-2xl shadow-lg">
                <div class="flex flex-col items-center space-y-6">
                    <div class="sidebar-item active p-3 rounded-xl bg-blue-500 bg-opacity-20 text-blue-400 tooltip-container" data-section="dashboard">
                        <i class="fas fa-chart-line text-xl"></i>
                        <span class="tooltip">Dashboard</span>
                    </div>
                    <div class="sidebar-item p-3 rounded-xl hover:bg-slate-700 transition-all duration-300 tooltip-container" data-section="markets">
                        <i class="fas fa-globe text-xl"></i>
                        <span class="tooltip">Markets</span>
                    </div>
                    <div class="sidebar-item p-3 rounded-xl hover:bg-slate-700 transition-all duration-300 tooltip-container" data-section="comparison">
                        <i class="fas fa-chart-bar text-xl"></i>
                        <span class="tooltip">Comparison</span>
                    </div>
                    <div class="sidebar-item p-3 rounded-xl hover:bg-slate-700 transition-all duration-300 tooltip-container" data-section="portfolio">
                        <i class="fas fa-briefcase text-xl"></i>
                        <span class="tooltip">Portfolio</span>
                    </div>
                </div>
            </div>

            <div class="ml-20">
                <!-- Dashboard Section -->
                <div id="dashboard-section" class="dashboard-content">
                    <!-- Single Stock Chart -->
                    <div class="glass-card p-6 mb-8">
                        <div class="flex justify-between items-center mb-6">
                            <div>
                                <h2 class="text-2xl font-bold text-white flex items-center">
                                    <i class="fas fa-chart-line mr-3 text-blue-400"></i>
                                    <span id="currentStockTitle">AAPL - Apple Inc.</span>
                                    <button id="refreshButton" class="ml-3 bg-blue-500 bg-opacity-20 p-1 rounded-full text-blue-400 hover:bg-opacity-30 transition-all" title="Refresh Data">
                                        <i class="fas fa-sync-alt"></i>
                                    </button>
                                </h2>
                                <p class="text-gray-400 mt-1">Real-time stock analysis</p>
                            </div>
                            <div class="flex items-center space-x-4">
                                <div class="text-right">
                                    <div class="text-2xl font-bold text-white" id="currentPrice">$175.34</div>
                                    <div class="text-sm" id="currentChange">
                                        <span class="text-green-400">+2.14 (+1.23%)</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex justify-between items-center mb-4">
                            <div class="flex space-x-1 bg-slate-800 p-1 rounded-lg">
                                <button class="time-range-btn active px-3 py-1 rounded-md text-xs font-medium" data-range="1h">1H</button>
                                <button class="time-range-btn px-3 py-1 rounded-md text-xs font-medium" data-range="1d">1D</button>
                                <button class="time-range-btn px-3 py-1 rounded-md text-xs font-medium" data-range="1w">1W</button>
                                <button class="time-range-btn px-3 py-1 rounded-md text-xs font-medium" data-range="1m">1M</button>
                                <button class="time-range-btn px-3 py-1 rounded-md text-xs font-medium" data-range="6m">6M</button>
                                <button class="time-range-btn px-3 py-1 rounded-md text-xs font-medium" data-range="1y">1Y</button>
                            </div>
                            <div>
                                <select id="chartTypeSelector" class="bg-slate-800 text-white text-xs rounded-md px-3 py-1 border border-gray-700" style="display: none;">
                                    <option value="line">Line Chart</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="h-96">
                            <canvas id="mainStockChart"></canvas>
                        </div>
                    </div>

                    <!-- News Section -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                        <div class="lg:col-span-2 glass-card p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-white flex items-center">
                                    <i class="fas fa-newspaper mr-2 text-blue-400"></i>
                                    Latest Market News
                                </h3>
                                <button id="refreshNews" class="btn-secondary px-3 py-1 rounded-full text-sm">
                                    <i class="fas fa-sync-alt mr-1"></i>Refresh
                                </button>
                            </div>
                            <div id="newsContainer" class="space-y-4 max-h-96 overflow-y-auto">
                                <!-- News items will be loaded here -->
                            </div>
                        </div>

                        <!-- Stock Details Panel -->
                        <div class="glass-card p-6">
                            <h3 class="text-xl font-bold text-white mb-4 flex items-center">
                                <i class="fas fa-info-circle mr-2 text-amber-400"></i>
                                Stock Details
                            </h3>
                            <div class="space-y-3">
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Market Cap</span>
                                    <span class="text-white font-semibold" id="detailMarketCap">$2.8T</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">P/E Ratio</span>
                                    <span class="text-white font-semibold" id="detailPE">28.5</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Volume</span>
                                    <span class="text-white font-semibold" id="detailVolume">58.0M</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">52W High</span>
                                    <span class="text-white font-semibold" id="detail52High">$198.23</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">52W Low</span>
                                    <span class="text-white font-semibold" id="detail52Low">$124.17</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Dividend Yield</span>
                                    <span class="text-white font-semibold" id="detailDividend">0.51%</span>
                                </div>
                            </div>
                            <button id="addToWatchlist" class="w-full mt-6 btn-primary px-4 py-2 rounded-lg text-sm font-medium">
                                <i class="fas fa-bookmark mr-2"></i>Add to Watchlist
                            </button>
                        </div>
                    </div>

                    <!-- Watchlist -->
                    <div class="glass-card p-6">
                        <div class="flex justify-between items-center mb-6">
                            <div class="flex items-center">
                                <div class="bg-blue-500 bg-opacity-20 p-2 rounded-lg mr-3">
                                    <i class="fas fa-bookmark text-blue-400"></i>
                                </div>
                                <div>
                                    <h3 class="text-xl font-bold text-white">My Watchlist</h3>
                                    <p class="text-sm text-gray-400">Track your favorite stocks</p>
                                </div>
                            </div>
                        </div>
                        <div id="watchlistContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <!-- Watchlist items will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Markets Section -->
                <div id="markets-section" class="section-hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                        <!-- Market News -->
                        <div class="glass-card p-6">
                            <h3 class="text-xl font-bold text-white mb-6 flex items-center">
                                <i class="fas fa-globe mr-2 text-blue-400"></i>
                                Global Market News
                            </h3>
                            <div id="marketNewsContainer" class="space-y-4 max-h-96 overflow-y-auto">
                                <!-- Market news will be loaded here -->
                            </div>
                        </div>

                        <!-- Top Companies -->
                        <div class="glass-card p-6">
                            <h3 class="text-xl font-bold text-white mb-6 flex items-center">
                                <i class="fas fa-building mr-2 text-amber-400"></i>
                                Top Companies by Market Cap
                            </h3>
                            <div id="topCompaniesContainer" class="space-y-3 max-h-96 overflow-y-auto">
                                <!-- Top companies list will be loaded here -->
                            </div>
                        </div>
                    </div>

                    <!-- Stock Market History -->
                    <div class="glass-card p-6">
                        <h3 class="text-xl font-bold text-white mb-6 flex items-center">
                            <i class="fas fa-history mr-2 text-green-400"></i>
                            Stock Market History & Facts
                        </h3>
                        <div id="marketHistoryContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <!-- Market history facts will be loaded here -->
                        </div>
                    </div>
                </div>

                <!-- Comparison Section -->
                <div id="comparison-section" class="section-hidden">
                    <div class="flex justify-center mb-8">
                        <div class="glass-card p-6">
                            <h2 class="text-2xl font-bold text-white text-center flex items-center justify-center">
                                <i class="fas fa-exchange-alt mr-3 text-amber-400"></i>
                                Stock Comparison
                            </h2>
                            <p class="text-gray-400 text-center mt-1">Compare two stocks side by side</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                        <!-- Stock 1 -->
                        <div class="glass-card p-6">
                            <div class="mb-4">
                                <input id="compStockSearch1" type="text" placeholder="Search any company worldwide" 
                                    class="w-full py-2 px-4 rounded-lg bg-slate-800 text-white border border-slate-600 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    list="compStockSuggestions1" autocomplete="off">
                                <datalist id="compStockSuggestions1">
                                    <!-- Suggestions will be populated dynamically -->
                                </datalist>
                            </div>
                            
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-semibold text-white" id="compStockSymbol1">AAPL</h3>
                                <div class="text-right">
                                    <div class="text-xl font-bold text-white" id="compPrice1">$175.34</div>
                                    <div class="text-sm text-green-400" id="compChange1">+1.23%</div>
                                </div>
                            </div>
                            
                            <div class="flex space-x-1 bg-slate-800 p-1 rounded-lg mb-4">
                                <button class="time-range-btn active px-3 py-1 rounded-md text-xs font-medium" data-chart="comp1" data-range="1h">1H</button>
                                <button class="time-range-btn px-3 py-1 rounded-md text-xs font-medium" data-chart="comp1" data-range="1d">1D</button>
                                <button class="time-range-btn px-3 py-1 rounded-md text-xs font-medium" data-chart="comp1" data-range="1w">1W</button>
                                <button class="time-range-btn px-3 py-1 rounded-md text-xs font-medium" data-chart="comp1" data-range="1m">1M</button>
                            </div>
                            
                            <div class="h-80">
                                <canvas id="comparisonChart1"></canvas>
                            </div>
                        </div>

                        <!-- Stock 2 -->
                        <div class="glass-card p-6">
                            <div class="mb-4">
                                <input id="compStockSearch2" type="text" placeholder="Search any company worldwide" 
                                    class="w-full py-2 px-4 rounded-lg bg-slate-800 text-white border border-slate-600 focus:outline-none focus:ring-2 focus:ring-amber-500"
                                    list="compStockSuggestions2" autocomplete="off">
                                <datalist id="compStockSuggestions2">
                                    <!-- Suggestions will be populated dynamically -->
                                </datalist>
                            </div>
                            
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-semibold text-white" id="compStockSymbol2">MSFT</h3>
                                <div class="text-right">
                                    <div class="text-xl font-bold text-white" id="compPrice2">$415.22</div>
                                    <div class="text-sm text-green-400" id="compChange2">+0.8%</div>
                                </div>
                            </div>
                            
                            <div class="flex space-x-1 bg-slate-800 p-1 rounded-lg mb-4">
                                <button class="time-range-btn active px-3 py-1 rounded-md text-xs font-medium" data-chart="comp2" data-range="1h">1H</button>
                                <button class="time-range-btn px-3 py-1 rounded-md text-xs font-medium" data-chart="comp2" data-range="1d">1D</button>
                                <button class="time-range-btn px-3 py-1 rounded-md text-xs font-medium" data-chart="comp2" data-range="1w">1W</button>
                                <button class="time-range-btn px-3 py-1 rounded-md text-xs font-medium" data-chart="comp2" data-range="1m">1M</button>
                            </div>
                            
                            <div class="h-80">
                                <canvas id="comparisonChart2"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Comparison Table -->
                    <div class="glass-card p-6">
                        <h3 class="text-xl font-bold text-white mb-6 flex items-center">
                            <i class="fas fa-table mr-2 text-amber-400"></i>
                            Detailed Comparison
                        </h3>
                        
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-slate-700">
                                <thead>
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 tracking-wider">Metric</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-blue-400 tracking-wider" id="compTableHeader1">AAPL</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-amber-400 tracking-wider" id="compTableHeader2">MSFT</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 tracking-wider">Difference</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-slate-800 divide-y divide-slate-700">
                                    <tr class="hover:bg-slate-700 transition-colors duration-200">
                                        <td class="px-4 py-3 text-sm font-medium text-white">Current Price</td>
                                        <td class="px-4 py-3 text-sm text-white" id="compTablePrice1">$175.34</td>
                                        <td class="px-4 py-3 text-sm text-white" id="compTablePrice2">$415.22</td>
                                        <td class="px-4 py-3 text-sm text-green-400" id="compTablePriceDiff">+136.8%</td>
                                    </tr>
                                    <tr class="hover:bg-slate-700 transition-colors duration-200">
                                        <td class="px-4 py-3 text-sm font-medium text-white">Market Cap</td>
                                        <td class="px-4 py-3 text-sm text-white" id="compTableMCap1">$2.8T</td>
                                        <td class="px-4 py-3 text-sm text-white" id="compTableMCap2">$3.1T</td>
                                        <td class="px-4 py-3 text-sm text-green-400" id="compTableMCapDiff">+10.7%</td>
                                    </tr>
                                    <tr class="hover:bg-slate-700 transition-colors duration-200">
                                        <td class="px-4 py-3 text-sm font-medium text-white">Volume</td>
                                        <td class="px-4 py-3 text-sm text-white" id="compTableVol1">58.0M</td>
                                        <td class="px-4 py-3 text-sm text-white" id="compTableVol2">25.0M</td>
                                        <td class="px-4 py-3 text-sm text-red-400" id="compTableVolDiff">-56.9%</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Portfolio Section -->
                <div id="portfolio-section" class="section-hidden">
                    <div class="flex justify-center mb-8">
                        <div class="glass-card p-6">
                            <h2 class="text-2xl font-bold text-white text-center flex items-center justify-center">
                                <i class="fas fa-briefcase mr-3 text-green-400"></i>
                                My Portfolio
                            </h2>
                            <p class="text-gray-400 text-center mt-1">Manage your investment interests</p>
                        </div>
                    </div>

                    <!-- Add Stock Form -->
                    <div class="glass-card p-6 mb-8">
                        <h3 class="text-xl font-bold text-white mb-6 flex items-center">
                            <i class="fas fa-plus mr-2 text-blue-400"></i>
                            Add Stock to Portfolio
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <input id="portfolioStockSymbol" type="text" placeholder="Stock Symbol (e.g., AAPL)" 
                                class="py-2 px-4 rounded-lg bg-slate-800 text-white border border-slate-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <input id="portfolioShares" type="number" placeholder="Number of Shares" 
                                class="py-2 px-4 rounded-lg bg-slate-800 text-white border border-slate-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <input id="portfolioBuyPrice" type="number" step="0.01" placeholder="Buy Price ($)" 
                                class="py-2 px-4 rounded-lg bg-slate-800 text-white border border-slate-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <button id="addToPortfolio" class="btn-primary px-6 py-2 rounded-lg font-medium">
                            <i class="fas fa-plus mr-2"></i>Add to Portfolio
                        </button>
                    </div>

                    <!-- Portfolio Holdings -->
                    <div class="glass-card p-6 mb-8">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-white flex items-center">
                                <i class="fas fa-chart-pie mr-2 text-amber-400"></i>
                                Portfolio Holdings
                            </h3>
                            <div class="text-right">
                                <div class="text-sm text-gray-400">Total Portfolio Value</div>
                                <div class="text-2xl font-bold text-white" id="totalPortfolioValue">$0.00</div>
                                <div class="text-sm" id="totalPortfolioChange">
                                    <span class="text-green-400">+$0.00 (0.00%)</span>
                                </div>
                            </div>
                        </div>
                        <div id="portfolioContainer" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Portfolio items will be loaded here -->
                        </div>
                    </div>

                    <!-- Portfolio Performance Chart -->
                    <div class="glass-card p-6">
                        <h3 class="text-xl font-bold text-white mb-6 flex items-center">
                            <i class="fas fa-chart-area mr-2 text-green-400"></i>
                            Portfolio Performance
                        </h3>
                        <div class="h-80">
                            <canvas id="portfolioChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <footer class="bg-gradient-to-r from-slate-800 to-slate-900 text-white py-8 mt-10">
            <div class="container mx-auto px-4 text-center">
                <div class="flex items-center justify-center mb-4">
                    <i class="fas fa-chart-line mr-2 text-blue-400"></i>
                    <span class="text-xl font-bold">StockVue Elite</span>
                </div>
                <p class="text-sm text-gray-400">This is a demo application. Stock data is simulated for demonstration purposes.</p>
                <p class="text-xs mt-2 text-gray-500">Â© 2024 StockVue Elite. All rights reserved.</p>
            </div>
        </footer>
    </div>

    <script>
        // Global variables
        let mainChart, compChart1, compChart2, portfolioChart;
        let currentSymbol = 'AAPL';
        let compSymbol1 = 'AAPL';
        let compSymbol2 = 'MSFT';
        let watchlist = ['AAPL', 'MSFT', 'GOOGL', 'AMZN'];
        let portfolio = [];
        let currentSection = 'dashboard';
        
        // API Configuration
        const ALPHA_VANTAGE_API_KEY = 'demo'; // Replace with your Alpha Vantage API key
        const FINANCIAL_MODELING_PREP_API_KEY = 'demo'; // Replace with your Financial Modeling Prep API key
        const REFRESH_INTERVAL = 10000; // 10 seconds
        let refreshTimer;
        let chartType = 'line'; // Default chart type (line or candlestick)
        let validStockSymbols = new Set(['AAPL', 'MSFT', 'GOOGL', 'AMZN', 'TSLA', 'META', 'NVDA', 'JPM']); // To store validated stock symbols
        let topCompanies = []; // To store top companies by market cap
        let globalCompanies = []; // To store global companies for search

        // Stock data
        const stockInfo = {
            'AAPL': { name: 'Apple Inc.', basePrice: 175, marketCap: 2.8e12, volume: 58000000 },
            'MSFT': { name: 'Microsoft Corporation', basePrice: 415, marketCap: 3.1e12, volume: 25000000 },
            'GOOGL': { name: 'Alphabet Inc.', basePrice: 142, marketCap: 1.8e12, volume: 30000000 },
            'AMZN': { name: 'Amazon.com Inc.', basePrice: 178, marketCap: 1.85e12, volume: 40000000 },
            'TSLA': { name: 'Tesla Inc.', basePrice: 240, marketCap: 7.6e11, volume: 120000000 },
            'META': { name: 'Meta Platforms Inc.', basePrice: 325, marketCap: 8.4e11, volume: 22000000 },
            'NVDA': { name: 'NVIDIA Corporation', basePrice: 480, marketCap: 1.2e12, volume: 45000000 },
            'JPM': { name: 'JPMorgan Chase & Co.', basePrice: 152, marketCap: 4.4e11, volume: 12000000 }
        };

        // Mock news data
        const mockNews = [
            {
                title: "Apple's AI Revolution: New iPhone Features Transform User Experience",
                source: "TechCrunch",
                time: "2 hours ago",
                category: "Technology",
                url: "https://www.indiatoday.in/technology/news/story/tim-cook-rallies-staff-says-ai-revolution-bigger-than-internet-and-apple-will-invest-to-grab-it-2765127-2025-08-02"
            },
            {
                title: "Microsoft Cloud Revenue Surpasses Expectations in Q3 Results",
                source: "Reuters",
                time: "4 hours ago",
                category: "Earnings",
                url: "https://www.thehindu.com/sci-tech/technology/microsofts-annual-cloud-revenue-hits-75-billion-profit-beats-expectations/article69876676.ece"
            },
            {
                title: "Tesla's Autopilot Technology Receives Major Safety Update",
                source: "Bloomberg",
                time: "6 hours ago",
                category: "Automotive",
                url: "https://www.nbcnews.com/news/us-news/tesla-autopilot-crash-trial-verdict-partly-liable-rcna222344"
            },
            {
                title: "Federal Reserve Considers Interest Rate Adjustments Amid Market Volatility",
                source: "Wall Street Journal",
                time: "8 hours ago",
                category: "Economy",
                url: "https://www.cnbc.com/2025/05/07/fed-rate-decision-may-2025.html"
            },
            {
                title: "NVIDIA's New AI Chips Drive Record Quarter Performance",
                source: "CNBC",
                time: "10 hours ago",
                category: "Technology",
                url: "https://www.investors.com/research/nvidia-stock-nvda-2/"
            }
        ];

        // Top companies data (based on market cap)
         topCompanies = [
            { symbol: "AAPL", name: "Apple Inc.", marketCap: "2.8T", change: "+1.2%" },
            { symbol: "MSFT", name: "Microsoft Corporation", marketCap: "3.1T", change: "+0.9%" },
            { symbol: "GOOGL", name: "Alphabet Inc.", marketCap: "1.8T", change: "-0.3%" },
            { symbol: "AMZN", name: "Amazon.com Inc.", marketCap: "1.85T", change: "+1.5%" },
            { symbol: "TSLA", name: "Tesla Inc.", marketCap: "0.76T", change: "+2.1%" },
            { symbol: "META", name: "Meta Platforms Inc.", marketCap: "0.84T", change: "-0.7%" },
            { symbol: "NVDA", name: "NVIDIA Corporation", marketCap: "1.2T", change: "+2.3%" },
            { symbol: "JPM", name: "JPMorgan Chase & Co.", marketCap: "0.44T", change: "+0.5%" }
        ];

        // Stock market history facts
        const marketFacts = [
            {
                title: "First Stock Exchange",
                description: "The Amsterdam Stock Exchange, established in 1602, was the world's first official stock market.",
                year: "1602"
            },
            {
                title: "Black Tuesday",
                description: "October 29, 1929 - The stock market crash that triggered the Great Depression.",
                year: "1929"
            },
            {
                title: "Dow Jones Created",
                description: "Charles Dow created the Dow Jones Industrial Average with just 12 companies.",
                year: "1896"
            },
            {
                title: "Electronic Trading",
                description: "NASDAQ became the first electronic stock exchange, revolutionizing trading.",
                year: "1971"
            },
            {
                title: "Circuit Breakers",
                description: "After Black Monday 1987, circuit breakers were introduced to halt trading during crashes.",
                year: "1987"
            },
            {
                title: "Longest Bull Market",
                description: "The bull market from 2009-2020 lasted 11 years, the longest in history.",
                year: "2009-2020"
            }
        ];

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Initializing StockVue Elite...');
            
            try {
                // Initialize theme based on user preference or default to dark mode
                initializeTheme();
                initializeCharts();
                setupEventListeners();
                loadDashboard();
                
                // Load global companies data for search
                loadGlobalCompanies();
                
                console.log('StockVue Elite initialized successfully');
            } catch (error) {
                console.error('Initialization error:', error);
            }
        });
        
        // Load global companies for search functionality
        async function loadGlobalCompanies() {
            try {
                // First try to load from Financial Modeling Prep API
                const response = await fetch(`https://financialmodelingprep.com/api/v3/stock/list?apikey=${FINANCIAL_MODELING_PREP_API_KEY}`);
                const data = await response.json();
                
                if (Array.isArray(data) && data.length > 0) {
                    globalCompanies = data.map(company => ({
                        symbol: company.symbol,
                        name: company.name,
                        exchange: company.exchange
                    }));
                    
                    // Populate all datalists with some initial suggestions
                    updateStockSuggestions(''); // Main search
                    updateStockSuggestions('', 'compStockSuggestions1'); // Comparison stock 1
                    updateStockSuggestions('', 'compStockSuggestions2'); // Comparison stock 2
                    
                    console.log(`Loaded ${globalCompanies.length} companies for global search`);
                } else {
                    // Fallback to default companies if API fails
                    console.warn('Failed to load global companies from API, using fallback data');
                    loadFallbackCompanies();
                }
            } catch (error) {
                console.error('Error loading global companies:', error);
                // Fallback to default companies if API fails
                loadFallbackCompanies();
            }
        }
        
        // Fallback companies data if API fails
        function loadFallbackCompanies() {
            // Add more global companies to the existing set
            const additionalCompanies = [
                // Asia
                { symbol: 'SONY', name: 'Sony Group Corporation', exchange: 'NYSE' },
                { symbol: 'SMSN', name: 'Samsung Electronics Co., Ltd.', exchange: 'LSE' },
                { symbol: 'TM', name: 'Toyota Motor Corporation', exchange: 'NYSE' },
                { symbol: 'BABA', name: 'Alibaba Group Holding Limited', exchange: 'NYSE' },
                { symbol: 'TCEHY', name: 'Tencent Holdings Limited', exchange: 'OTC' },
                { symbol: 'HDB', name: 'HDFC Bank Limited', exchange: 'NYSE' },
                { symbol: 'IBN', name: 'ICICI Bank Limited', exchange: 'NYSE' },
                { symbol: 'PTR', name: 'PetroChina Company Limited', exchange: 'NYSE' },
                { symbol: 'RELIANCE.NS', name: 'Reliance Industries Limited', exchange: 'NSE' },
                { symbol: 'TCS.NS', name: 'Tata Consultancy Services Limited', exchange: 'NSE' },
                { symbol: '7203.T', name: 'Toyota Motor Corporation', exchange: 'TSE' },
                { symbol: '005930.KS', name: 'Samsung Electronics Co., Ltd.', exchange: 'KRX' },
                { symbol: '9988.HK', name: 'Alibaba Group Holding Limited', exchange: 'HKEX' },
                { symbol: '0700.HK', name: 'Tencent Holdings Limited', exchange: 'HKEX' },
                { symbol: '1299.HK', name: 'AIA Group Limited', exchange: 'HKEX' },
                { symbol: '9618.HK', name: 'JD.com, Inc.', exchange: 'HKEX' },
                { symbol: '9999.HK', name: 'NetEase, Inc.', exchange: 'HKEX' },
                { symbol: '9888.HK', name: 'Baidu, Inc.', exchange: 'HKEX' },
                { symbol: '3690.HK', name: 'Meituan', exchange: 'HKEX' },
                { symbol: '6098.T', name: 'Recruit Holdings Co., Ltd.', exchange: 'TSE' },
                { symbol: '6758.T', name: 'Sony Group Corporation', exchange: 'TSE' },
                { symbol: '6861.T', name: 'Keyence Corporation', exchange: 'TSE' },
                { symbol: '9984.T', name: 'SoftBank Group Corp.', exchange: 'TSE' },
                
                // Europe
                { symbol: 'NESN', name: 'NestlÃ© S.A.', exchange: 'SWX' },
                { symbol: 'ASML', name: 'ASML Holding N.V.', exchange: 'NASDAQ' },
                { symbol: 'SAP', name: 'SAP SE', exchange: 'NYSE' },
                { symbol: 'SHEL', name: 'Shell plc', exchange: 'NYSE' },
                { symbol: 'BP', name: 'BP p.l.c.', exchange: 'NYSE' },
                { symbol: 'SIEGY', name: 'Siemens AG', exchange: 'OTC' },
                { symbol: 'LVMUY', name: 'LVMH MoÃ«t Hennessy - Louis Vuitton', exchange: 'OTC' },
                { symbol: 'NSRGY', name: 'NestlÃ© S.A.', exchange: 'OTC' },
                { symbol: 'RHHBY', name: 'Roche Holding AG', exchange: 'OTC' },
                { symbol: 'NOVN', name: 'Novartis AG', exchange: 'SWX' },
                { symbol: 'ADYEY', name: 'Adyen N.V.', exchange: 'OTC' },
                { symbol: 'MC.PA', name: 'LVMH MoÃ«t Hennessy - Louis Vuitton', exchange: 'Euronext Paris' },
                { symbol: 'OR.PA', name: 'L\'OrÃ©al S.A.', exchange: 'Euronext Paris' },
                { symbol: 'SAN.PA', name: 'Sanofi', exchange: 'Euronext Paris' },
                { symbol: 'AIR.PA', name: 'Airbus SE', exchange: 'Euronext Paris' },
                { symbol: 'BN.PA', name: 'Danone S.A.', exchange: 'Euronext Paris' },
                { symbol: 'SIE.DE', name: 'Siemens AG', exchange: 'XETRA' },
                { symbol: 'ALV.DE', name: 'Allianz SE', exchange: 'XETRA' },
                { symbol: 'SAP.DE', name: 'SAP SE', exchange: 'XETRA' },
                { symbol: 'DTE.DE', name: 'Deutsche Telekom AG', exchange: 'XETRA' },
                { symbol: 'VOW3.DE', name: 'Volkswagen AG', exchange: 'XETRA' },
                { symbol: 'ULVR.L', name: 'Unilever PLC', exchange: 'LSE' },
                { symbol: 'AZN.L', name: 'AstraZeneca PLC', exchange: 'LSE' },
                { symbol: 'HSBA.L', name: 'HSBC Holdings plc', exchange: 'LSE' },
                { symbol: 'GSK.L', name: 'GSK plc', exchange: 'LSE' },
                { symbol: 'RIO.L', name: 'Rio Tinto Group', exchange: 'LSE' },
                
                // Americas
                { symbol: 'RIO', name: 'Rio Tinto Group', exchange: 'NYSE' },
                { symbol: 'BHP', name: 'BHP Group Limited', exchange: 'NYSE' },
                { symbol: 'VALE', name: 'Vale S.A.', exchange: 'NYSE' },
                { symbol: 'SHOP', name: 'Shopify Inc.', exchange: 'NYSE' },
                { symbol: 'SE', name: 'Sea Limited', exchange: 'NYSE' },
                { symbol: 'MELI', name: 'MercadoLibre, Inc.', exchange: 'NASDAQ' },
                { symbol: 'ITUB', name: 'ItaÃº Unibanco Holding S.A.', exchange: 'NYSE' },
                { symbol: 'BBD', name: 'Banco Bradesco S.A.', exchange: 'NYSE' },
                { symbol: 'PBR', name: 'PetrÃ³leo Brasileiro S.A. - Petrobras', exchange: 'NYSE' },
                { symbol: 'ABEV', name: 'Ambev S.A.', exchange: 'NYSE' },
                { symbol: 'CX', name: 'CEMEX, S.A.B. de C.V.', exchange: 'NYSE' },
                { symbol: 'AMX', name: 'AmÃ©rica MÃ³vil, S.A.B. de C.V.', exchange: 'NYSE' },
                { symbol: 'TV', name: 'Grupo Televisa, S.A.B.', exchange: 'NYSE' },
                
                // Africa & Middle East
                { symbol: 'SSL', name: 'Sasol Limited', exchange: 'NYSE' },
                { symbol: 'GFI', name: 'Gold Fields Limited', exchange: 'NYSE' },
                { symbol: 'AU', name: 'AngloGold Ashanti Limited', exchange: 'NYSE' },
                { symbol: 'MTN.JO', name: 'MTN Group Limited', exchange: 'JSE' },
                { symbol: 'SBK.JO', name: 'Standard Bank Group Limited', exchange: 'JSE' },
                { symbol: 'FSR.JO', name: 'FirstRand Limited', exchange: 'JSE' },
                { symbol: 'NPN.JO', name: 'Naspers Limited', exchange: 'JSE' },
                { symbol: 'TEVA', name: 'Teva Pharmaceutical Industries Limited', exchange: 'NYSE' },
                { symbol: 'ICL', name: 'ICL Group Ltd.', exchange: 'NYSE' },
                { symbol: 'NICE', name: 'NICE Ltd.', exchange: 'NASDAQ' }
            ];
            
            globalCompanies = [
                ...Object.entries(stockInfo).map(([symbol, info]) => ({
                    symbol: symbol,
                    name: info.name,
                    exchange: 'NASDAQ'
                })),
                ...additionalCompanies
            ];
            
            // Populate all datalists with initial suggestions
            updateStockSuggestions(''); // Main search
            updateStockSuggestions('', 'compStockSuggestions1'); // Comparison stock 1
            updateStockSuggestions('', 'compStockSuggestions2'); // Comparison stock 2
            
            console.log(`Loaded ${globalCompanies.length} fallback companies for global search`);
        }
        
        // Initialize theme
        function initializeTheme() {
            // Check if user has a saved preference
            const savedTheme = localStorage.getItem('theme');
            const themeToggle = document.getElementById('themeToggle');
            
            if (savedTheme === 'light') {
                document.documentElement.classList.add('light-mode');
                themeToggle.checked = true;
            }
            
            // Add event listener for theme toggle
            themeToggle.addEventListener('change', function() {
                if (this.checked) {
                    // Switch to light mode
                    document.documentElement.classList.add('light-mode');
                    localStorage.setItem('theme', 'light');
                } else {
                    // Switch to dark mode
                    document.documentElement.classList.remove('light-mode');
                    localStorage.setItem('theme', 'dark');
                }
                
                // Update charts to match new theme
                updateChartsForTheme();
            });
        }
        
        // Update charts when theme changes
        function updateChartsForTheme() {
            const isLightMode = document.documentElement.classList.contains('light-mode');
            
            // Update chart colors based on theme
            Chart.defaults.color = isLightMode ? '#334155' : '#94a3b8';
            Chart.defaults.borderColor = isLightMode ? 'rgba(203, 213, 225, 0.2)' : 'rgba(148, 163, 184, 0.2)';
            
            // Update tooltip styles
            Chart.defaults.plugins.tooltip.backgroundColor = isLightMode ? 'rgba(255, 255, 255, 0.9)' : 'rgba(30, 41, 59, 0.9)';
            Chart.defaults.plugins.tooltip.titleColor = isLightMode ? '#0f172a' : '#f8fafc';
            Chart.defaults.plugins.tooltip.bodyColor = isLightMode ? '#334155' : '#cbd5e1';
            Chart.defaults.plugins.tooltip.borderColor = isLightMode ? 'rgba(203, 213, 225, 0.3)' : 'rgba(148, 163, 184, 0.2)';
            
            // Redraw charts with updated colors
            if (mainChart) {
                updateMainChartData('1h');
            }
            
            if (compChart1 && compChart2) {
                const comp1Range = document.querySelector('.time-range-btn[data-chart="comp1"].active');
                const comp2Range = document.querySelector('.time-range-btn[data-chart="comp2"].active');
                
                if (comp1Range) updateComparisonChartData('comp1', comp1Range.dataset.range);
                if (comp2Range) updateComparisonChartData('comp2', comp2Range.dataset.range);
            }
            
            if (portfolioChart) {
                updatePortfolioChart();
            }
        }

        // Initialize charts
        function initializeCharts() {
            // Main dashboard chart
            const mainCtx = document.getElementById('mainStockChart').getContext('2d');
            mainChart = new Chart(mainCtx, createChartConfig('#3b82f6'));

            // Comparison charts
            const comp1Ctx = document.getElementById('comparisonChart1').getContext('2d');
            const comp2Ctx = document.getElementById('comparisonChart2').getContext('2d');
            compChart1 = new Chart(comp1Ctx, createChartConfig('#3b82f6'));
            compChart2 = new Chart(comp2Ctx, createChartConfig('#f59e0b'));

            // Portfolio chart
            const portfolioCtx = document.getElementById('portfolioChart').getContext('2d');
            portfolioChart = new Chart(portfolioCtx, createPortfolioChartConfig());
        }

        function createChartConfig(color) {
            const isLightMode = document.documentElement.classList.contains('light-mode');
            
            return {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Price',
                        data: [],
                        borderColor: color,
                        backgroundColor: color + '20',
                        borderWidth: 2,
                        pointRadius: 0,
                        pointHoverRadius: 4,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: isLightMode ? 'rgba(255, 255, 255, 0.9)' : 'rgba(30, 41, 59, 0.9)',
                            titleColor: isLightMode ? '#0f172a' : '#f8fafc',
                            bodyColor: isLightMode ? '#334155' : '#cbd5e1',
                            borderColor: isLightMode ? 'rgba(203, 213, 225, 0.3)' : 'rgba(148, 163, 184, 0.2)',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: isLightMode ? 'rgba(203, 213, 225, 0.2)' : 'rgba(148, 163, 184, 0.1)', drawBorder: false },
                            ticks: { color: isLightMode ? '#334155' : '#94a3b8', font: { size: 10 } }
                        },
                        y: {
                            grid: { color: isLightMode ? 'rgba(203, 213, 225, 0.2)' : 'rgba(148, 163, 184, 0.1)', drawBorder: false },
                            ticks: {
                                color: isLightMode ? '#334155' : '#94a3b8',
                                font: { size: 10 },
                                callback: function(value) { return '$' + value.toFixed(2); },
                                display: true // Make Y-axis values visible
                            }
                        }
                    },
                    interaction: { intersect: false, mode: 'index' }
                }
            };
        }

        function createPortfolioChartConfig() {
            const isLightMode = document.documentElement.classList.contains('light-mode');
            
            return {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Portfolio Value',
                        data: [],
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: 2,
                        pointRadius: 0,
                        pointHoverRadius: 4,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: isLightMode ? 'rgba(255, 255, 255, 0.9)' : 'rgba(30, 41, 59, 0.9)',
                            titleColor: isLightMode ? '#0f172a' : '#f8fafc',
                            bodyColor: isLightMode ? '#334155' : '#cbd5e1',
                            borderColor: isLightMode ? 'rgba(203, 213, 225, 0.3)' : 'rgba(148, 163, 184, 0.2)',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    return 'Portfolio Value: '
                         + context.parsed.y.toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: isLightMode ? 'rgba(203, 213, 225, 0.2)' : 'rgba(148, 163, 184, 0.1)', drawBorder: false },
                            ticks: { color: isLightMode ? '#334155' : '#94a3b8', font: { size: 10 } }
                        },
                        y: {
                            grid: { color: isLightMode ? 'rgba(203, 213, 225, 0.2)' : 'rgba(148, 163, 184, 0.1)', drawBorder: false },
                            ticks: {
                                color: isLightMode ? '#334155' : '#94a3b8',
                                font: { size: 10 },
                                callback: function(value) { 
                                    return '$' + value.toLocaleString(); 
                                },
                                display: true // Make Y-axis values visible
                            }
                        }
                    }
                }
            };
        }

        // Setup event listeners
        function setupEventListeners() {
            // Sidebar navigation
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.addEventListener('click', function() {
                    const section = this.dataset.section;
                    switchSection(section);
                });
            });

            // Main search
            const stockSearch = document.getElementById('stockSearch');
            stockSearch.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    const input = this.value.trim();
                    if (input) {
                        // Check if input is a symbol or company name
                        searchAndUpdateStock(input);
                    }
                }
            });
            
            // Add input event for real-time suggestions
            stockSearch.addEventListener('input', function() {
                const query = this.value.trim();
                updateStockSuggestions(query);
            });
            
            // Add search button click handler
            document.getElementById('searchButton').addEventListener('click', function() {
                const input = stockSearch.value.trim();
                if (input) {
                    searchAndUpdateStock(input);
                }
            });

            // Quick access panels
            document.querySelectorAll('[data-symbol]').forEach(panel => {
                panel.addEventListener('click', function() {
                    const symbol = this.dataset.symbol;
                    updateMainStock(symbol);
                });
            });
            
            // Chart type selector removed (candlestick chart functionality removed as requested)

            // Time range buttons for main chart
            document.querySelectorAll('.time-range-btn:not([data-chart])').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.time-range-btn:not([data-chart])').forEach(b => {
                        b.classList.remove('active');
                    });
                    this.classList.add('active');
                    updateMainChartData(this.dataset.range);
                });
            });

            // Comparison chart event listeners
            setupComparisonEventListeners();

            // Portfolio event listeners
            setupPortfolioEventListeners();

            // Add to watchlist
            document.getElementById('addToWatchlist').addEventListener('click', function() {
                if (currentSymbol && !watchlist.includes(currentSymbol)) {
                    watchlist.push(currentSymbol);
                    updateWatchlist();
                }
            });

            // Refresh news
            document.getElementById('refreshNews').addEventListener('click', function() {
                loadNews();
            });
        }

        function setupComparisonEventListeners() {
            // Comparison search inputs
            const compSearch1 = document.getElementById('compStockSearch1');
            const compSearch2 = document.getElementById('compStockSearch2');

            compSearch1.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    const input = this.value.trim();
                    if (input) {
                        searchAndUpdateComparisonStock(input, 1);
                    }
                }
            });

            compSearch2.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    const input = this.value.trim();
                    if (input) {
                        searchAndUpdateComparisonStock(input, 2);
                    }
                }
            });
            
            // Add input event for real-time suggestions
            compSearch1.addEventListener('input', function() {
                const query = this.value.trim();
                updateStockSuggestions(query, 'compStockSuggestions1');
            });
            
            compSearch2.addEventListener('input', function() {
                const query = this.value.trim();
                updateStockSuggestions(query, 'compStockSuggestions2');
            });

            // Comparison time range buttons
            document.querySelectorAll('.time-range-btn[data-chart]').forEach(btn => {
                btn.addEventListener('click', function() {
                    const chartId = this.dataset.chart;
                    document.querySelectorAll(`.time-range-btn[data-chart="${chartId}"]`).forEach(b => {
                        b.classList.remove('active');
                    });
                    this.classList.add('active');
                    updateComparisonChartData(chartId, this.dataset.range);
                });
            });
        }

        function setupPortfolioEventListeners() {
            document.getElementById('addToPortfolio').addEventListener('click', function() {
                const symbol = document.getElementById('portfolioStockSymbol').value.trim().toUpperCase();
                const shares = parseFloat(document.getElementById('portfolioShares').value);
                const buyPrice = parseFloat(document.getElementById('portfolioBuyPrice').value);

                if (symbol && shares > 0 && buyPrice > 0) {
                    addToPortfolio(symbol, shares, buyPrice);
                    // Clear form
                    document.getElementById('portfolioStockSymbol').value = '';
                    document.getElementById('portfolioShares').value = '';
                    document.getElementById('portfolioBuyPrice').value = '';
                }
            });
        }

        // Section switching
        function switchSection(section) {
            // Update sidebar
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active', 'bg-blue-500', 'bg-opacity-20', 'text-blue-400');
            });
            document.querySelector(`[data-section="${section}"]`).classList.add('active', 'bg-blue-500', 'bg-opacity-20', 'text-blue-400');

            // Hide all sections
            document.querySelectorAll('[id$="-section"]').forEach(sec => {
                sec.classList.add('section-hidden');
            });

            // Show selected section
            document.getElementById(section + '-section').classList.remove('section-hidden');
            currentSection = section;
            
            // Ensure theme persistence when switching sections
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'light') {
                document.documentElement.classList.add('light-mode');
                if (document.getElementById('themeToggle')) {
                    document.getElementById('themeToggle').checked = true;
                }
            }

            // Load section-specific data
            switch(section) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'markets':
                    loadMarketsSection();
                    break;
                case 'comparison':
                    loadComparisonSection();
                    break;
                case 'portfolio':
                    loadPortfolioSection();
                    break;
            }
        }

        // Dashboard functions
        function loadDashboard() {
            updateMainStock(currentSymbol);
            loadNews();
            updateWatchlist();
            
            // Add refresh button event listener
            document.getElementById('refreshButton').addEventListener('click', function() {
                refreshStockData();
            });
            
            // Start auto-refresh timer
            startRefreshTimer();
        }

        function updateMainStock(symbol) {
            // Validate the stock symbol
            if (!validStockSymbols.has(symbol)) {
                validateStockSymbol(symbol);
                return;
            }
            
            currentSymbol = symbol;
            const info = stockInfo[symbol] || { name: `${symbol} Inc.`, basePrice: 100 };
            
            // Update title and price
            document.getElementById('currentStockTitle').textContent = `${symbol} - ${info.name}`;
            
            // Try to fetch real-time data from Alpha Vantage
            fetchStockData(symbol)
                .then(data => {
                    if (data) {
                        // Update with real data
                        updateUIWithRealData(data);
                    } else {
                        // Fallback to mock data
                        updateUIWithMockData(symbol, info);
                    }
                })
                .catch(error => {
                    console.error('Error fetching stock data:', error);
                    // Fallback to mock data
                    updateUIWithMockData(symbol, info);
                });
            
            // Update chart
            updateMainChartData('1h');
        }
        
        function updateUIWithRealData(data) {
            // Update price and change
            const price = parseFloat(data.price);
            const previousClose = parseFloat(data.previousClose);
            const change = price - previousClose;
            const changePercent = (change / previousClose * 100);
            
            document.getElementById('currentPrice').textContent = `${price.toFixed(2)}`;
            
            const changeClass = change >= 0 ? 'text-green-400' : 'text-red-400';
            const changeSign = change >= 0 ? '+' : '';
            
            document.getElementById('currentChange').innerHTML = 
                `<span class="${changeClass}">${changeSign}${change.toFixed(2)} (${changeSign}${changePercent.toFixed(2)}%)</span>`;
            
            // Update details panel with real data
            document.getElementById('detailMarketCap').textContent = formatMarketCap(data.marketCap || stockInfo[currentSymbol].marketCap);
            document.getElementById('detailPE').textContent = data.pe ? data.pe.toFixed(2) : 'N/A';
            document.getElementById('detailVolume').textContent = formatVolume(data.volume || stockInfo[currentSymbol].volume);
            document.getElementById('detail52High').textContent = data.high52Week ? `$${data.high52Week.toFixed(2)}` : `$${(stockInfo[currentSymbol].basePrice * 1.3).toFixed(2)}`;
            document.getElementById('detail52Low').textContent = data.low52Week ? `$${data.low52Week.toFixed(2)}` : `$${(stockInfo[currentSymbol].basePrice * 0.7).toFixed(2)}`;
            document.getElementById('detailDividend').textContent = data.dividendYield ? `${data.dividendYield.toFixed(2)}%` : `${(Math.random() * 3).toFixed(2)}%`;
        }
        
        function updateUIWithMockData(symbol, info) {
            // Generate random change
            const change = (Math.random() - 0.5) * 10;
            const changePercent = (change / info.basePrice * 100).toFixed(2);
            const changeClass = change >= 0 ? 'text-green-400' : 'text-red-400';
            const changeSign = change >= 0 ? '+' : '';
            
            document.getElementById('currentPrice').textContent = `${info.basePrice.toFixed(2)}`;
            document.getElementById('currentChange').innerHTML = 
                `<span class="${changeClass}">${changeSign}${change.toFixed(2)} (${changeSign}${changePercent}%)</span>`;

            // Update details panel
            updateStockDetails(symbol, info);
        }
        
        // Function to update stock suggestions based on user input
        function updateStockSuggestions(query, datalistId = 'stockSuggestions') {
            const datalist = document.getElementById(datalistId);
            if (!datalist) return; // Exit if datalist doesn't exist
            
            datalist.innerHTML = '';
            
            if (!query) {
                // Show top companies if no query
                const topSuggestions = globalCompanies.slice(0, 20);
                topSuggestions.forEach(company => {
                    const option = document.createElement('option');
                    option.value = company.symbol;
                    option.textContent = `${company.name} (${company.exchange})`;
                    datalist.appendChild(option);
                });
                return;
            }
            
            // Filter companies based on query (match symbol or name)
            const queryLower = query.toLowerCase();
            const matches = globalCompanies.filter(company => 
                company.symbol.toLowerCase().includes(queryLower) || 
                company.name.toLowerCase().includes(queryLower)
            ).slice(0, 20); // Limit to 20 suggestions
            
            matches.forEach(company => {
                const option = document.createElement('option');
                option.value = company.symbol;
                option.textContent = `${company.name} (${company.exchange})`;
                datalist.appendChild(option);
            });
        }
        
        // Function to search for a company by name or symbol and update the stock display
        function searchAndUpdateStock(input) {
            // First check if input is a valid symbol
            const symbolMatch = globalCompanies.find(company => 
                company.symbol.toUpperCase() === input.toUpperCase()
            );
            
            if (symbolMatch) {
                // Direct symbol match found
                validateAndUpdateStock(symbolMatch.symbol);
                return;
            }
            
            // Check if input is a company name
            const nameMatches = globalCompanies.filter(company => 
                company.name.toLowerCase().includes(input.toLowerCase())
            );
            
            if (nameMatches.length > 0) {
                // Use the first matching company
                validateAndUpdateStock(nameMatches[0].symbol);
                return;
            }
            
            // If no matches found in our database, try Alpha Vantage API
            validateStockSymbol(input.toUpperCase());
        }
        
        // Function to validate and update stock display
        function validateAndUpdateStock(symbol) {
            // Add to valid symbols set if not already there
            if (!validStockSymbols.has(symbol)) {
                validStockSymbols.add(symbol);
                
                // Find company info from global companies
                const companyInfo = globalCompanies.find(company => company.symbol === symbol);
                
                // Add to stockInfo if not exists
                if (!stockInfo[symbol]) {
                    stockInfo[symbol] = {
                        name: companyInfo ? companyInfo.name : `${symbol} Inc.`,
                        basePrice: 100 + Math.random() * 200,
                        marketCap: Math.random() * 1e12,
                        volume: Math.random() * 10000000
                    };
                }
            }
            
            // Update the stock display
            updateMainStock(symbol);
        }
        
        async function validateStockSymbol(symbol) {
            try {
                const response = await fetch(`https://www.alphavantage.co/query?function=SYMBOL_SEARCH&keywords=${symbol}&apikey=${ALPHA_VANTAGE_API_KEY}`);
                const data = await response.json();
                
                if (data.bestMatches && data.bestMatches.length > 0) {
                    // Found a valid symbol
                    const match = data.bestMatches[0];
                    const validSymbol = match['1. symbol'];
                    const name = match['2. name'];
                    
                    // Add to valid symbols set
                    validStockSymbols.add(validSymbol);
                    
                    // Add to stockInfo if not exists
                    if (!stockInfo[validSymbol]) {
                        stockInfo[validSymbol] = {
                            name: name,
                            basePrice: 100 + Math.random() * 200,
                            marketCap: Math.random() * 1e12,
                            volume: Math.random() * 10000000
                        };
                    }
                    
                    // Add to global companies if not exists
                    if (!globalCompanies.some(company => company.symbol === validSymbol)) {
                        globalCompanies.push({
                            symbol: validSymbol,
                            name: name,
                            exchange: match['4. region'] || 'UNKNOWN'
                        });
                    }
                    
                    // Update the stock display
                    updateMainStock(validSymbol);
                } else {
                    alert(`Invalid stock symbol or company name: ${symbol}. Please try another search.`);
                }
            } catch (error) {
                console.error('Error validating stock symbol:', error);
                alert(`Error validating stock symbol: ${symbol}. Please try another search.`);
            }
        }
        
        async function fetchStockData(symbol) {
            try {
                // Global quote for current price and change
                const response = await fetch(`https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${symbol}&apikey=${ALPHA_VANTAGE_API_KEY}`);
                const data = await response.json();
                
                if (data['Global Quote']) {
                    const quote = data['Global Quote'];
                    return {
                        price: quote['05. price'],
                        previousClose: quote['08. previous close'],
                        change: quote['09. change'],
                        changePercent: quote['10. change percent'],
                        volume: parseInt(quote['06. volume']),
                        // Other fields would need additional API calls
                        marketCap: stockInfo[symbol].marketCap,
                        pe: null,
                        high52Week: null,
                        low52Week: null,
                        dividendYield: null
                    };
                }
                return null;
            } catch (error) {
                console.error('Error fetching stock data:', error);
                return null;
            }
        }
        
        function refreshStockData() {
            // Show refresh animation
            const refreshButton = document.getElementById('refreshButton');
            refreshButton.classList.add('animate-spin');
            
            // Fetch fresh data
            updateMainStock(currentSymbol);
            
            // Stop animation after 1 second
            setTimeout(() => {
                refreshButton.classList.remove('animate-spin');
            }, 1000);
        }
        
        function startRefreshTimer() {
            // Clear any existing timer
            if (refreshTimer) {
                clearInterval(refreshTimer);
            }
            
            // Set up new timer
            refreshTimer = setInterval(() => {
                refreshStockData();
            }, REFRESH_INTERVAL);
        }

        function updateStockDetails(symbol, info) {
            document.getElementById('detailMarketCap').textContent = formatMarketCap(info.marketCap);
            document.getElementById('detailPE').textContent = (Math.random() * 30 + 5).toFixed(1);
            document.getElementById('detailVolume').textContent = formatVolume(info.volume);
            document.getElementById('detail52High').textContent = `${(info.basePrice * 1.3).toFixed(2)}`;
            document.getElementById('detail52Low').textContent = `${(info.basePrice * 0.7).toFixed(2)}`;
            document.getElementById('detailDividend').textContent = `${(Math.random() * 3).toFixed(2)}%`;
        }

        function updateMainChartData(timeRange) {
            // Always use line chart (candlestick removed as requested)
            chartType = 'line';
            
            // Line chart data
            const chartData = generateChartData(currentSymbol, timeRange);
            
            // Update chart configuration if needed
            if (mainChart.config.type !== 'line') {
                // Destroy and recreate as line chart
                mainChart.destroy();
                const ctx = document.getElementById('mainStockChart').getContext('2d');
                mainChart = new Chart(ctx, createChartConfig());
            }
            
            mainChart.data.labels = chartData.labels;
            mainChart.data.datasets[0].data = chartData.prices;
            mainChart.update('none');
        }
        
        function generateCandlestickData(symbol, timeRange) {
            // Generate mock candlestick data
            const basePrice = stockInfo[symbol].basePrice;
            const volatility = basePrice * 0.02; // 2% volatility
            const data = [];
            
            let numPoints;
            switch (timeRange) {
                case '1h': numPoints = 60; break; // 1-minute intervals
                case '1d': numPoints = 24; break; // hourly intervals
                case '1w': numPoints = 7; break;  // daily intervals
                case '1m': numPoints = 30; break; // daily intervals
                case '6m': numPoints = 24; break; // weekly intervals
                case '1y': numPoints = 52; break; // weekly intervals
                default: numPoints = 24;
            }
            
            let currentPrice = basePrice;
            const now = new Date();
            
            for (let i = 0; i < numPoints; i++) {
                // Calculate time for this candle
                let date;
                switch (timeRange) {
                    case '1h':
                        date = new Date(now.getTime() - (numPoints - i) * 60 * 1000);
                        break;
                    case '1d':
                        date = new Date(now.getTime() - (numPoints - i) * 60 * 60 * 1000);
                        break;
                    case '1w':
                        date = new Date(now.getTime() - (numPoints - i) * 24 * 60 * 60 * 1000);
                        break;
                    case '1m':
                        date = new Date(now.getTime() - (numPoints - i) * 24 * 60 * 60 * 1000);
                        break;
                    case '6m':
                        date = new Date(now.getTime() - (numPoints - i) * 7 * 24 * 60 * 60 * 1000);
                        break;
                    case '1y':
                        date = new Date(now.getTime() - (numPoints - i) * 7 * 24 * 60 * 60 * 1000);
                        break;
                }
                
                // Generate random price movements
                const open = currentPrice;
                const close = open + (Math.random() - 0.5) * volatility * 2;
                const high = Math.max(open, close) + Math.random() * volatility;
                const low = Math.min(open, close) - Math.random() * volatility;
                
                // Add candle data
                data.push({
                    x: date,
                    o: open,
                    h: high,
                    l: low,
                    c: close
                });
                
                currentPrice = close;
            }
            
            return data;
        }
        
        function createCandlestickChartConfig() {
            return {
                type: 'candlestick',
                data: {
                    datasets: [{
                        label: currentSymbol,
                        data: []
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'day',
                                displayFormats: {
                                    day: 'MMM d'
                                }
                            },
                            grid: { color: 'rgba(148, 163, 184, 0.1)', drawBorder: false },
                            ticks: { color: '#94a3b8', font: { size: 10 } }
                        },
                        y: {
                            grid: { color: 'rgba(148, 163, 184, 0.1)', drawBorder: false },
                            ticks: {
                                color: '#94a3b8',
                                font: { size: 10 },
                                callback: function(value) { return '$' + value.toFixed(2); }
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(30, 41, 59, 0.9)',
                            titleColor: '#f8fafc',
                            bodyColor: '#cbd5e1',
                            borderColor: 'rgba(148, 163, 184, 0.2)',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    const point = context.raw;
                                    return [
                                        `Open: $${point.o.toFixed(2)}`,
                                        `High: $${point.h.toFixed(2)}`,
                                        `Low: $${point.l.toFixed(2)}`,
                                        `Close: $${point.c.toFixed(2)}`
                                    ];
                                }
                            }
                        }
                    }
                }
            };
        }

        function loadNews() {
            const newsContainer = document.getElementById('newsContainer');
            newsContainer.innerHTML = '';

            // Add some loading shimmer
            for (let i = 0; i < 3; i++) {
                const shimmer = document.createElement('div');
                shimmer.className = 'shimmer h-20 mb-4';
                newsContainer.appendChild(shimmer);
            }

            // Simulate API delay
            setTimeout(() => {
                newsContainer.innerHTML = '';
                mockNews.forEach(news => {
                    const newsItem = createNewsItem(news);
                    newsContainer.appendChild(newsItem);
                });
            }, 800);
        }

        function createNewsItem(news) {
            const item = document.createElement('div');
            item.className = 'news-item glass-card p-4 rounded-lg';
            const isLightMode = document.documentElement.classList.contains('light-mode');
            item.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <span class="text-xs text-blue-400 bg-blue-500 bg-opacity-20 px-2 py-1 rounded">${news.category}</span>
                    <span class="text-xs ${isLightMode ? 'text-gray-600' : 'text-gray-400'}">${news.time}</span>
                </div>
                <h4 class="${isLightMode ? 'text-slate-800' : 'text-white'} font-semibold mb-2 line-clamp-2">${news.title}</h4>
                <div class="flex justify-between items-center">
                    <span class="text-sm ${isLightMode ? 'text-gray-600' : 'text-gray-400'}">${news.source}</span>
                    <i class="fas fa-external-link-alt ${isLightMode ? 'text-gray-600' : 'text-gray-400'} text-xs"></i>
                </div>
            `;
            
            item.addEventListener('click', () => {
                window.open(news.url, '_blank');
            });
            
            return item;
        }

        function updateWatchlist() {
            const container = document.getElementById('watchlistContainer');
            container.innerHTML = '';

            watchlist.forEach(symbol => {
                const stockData = generateMockStockData(symbol);
                const card = createWatchlistCard(stockData);
                container.appendChild(card);
            });
        }

        function createWatchlistCard(data) {
            const card = document.createElement('div');
            const changeClass = data.change >= 0 ? 'positive' : 'negative';
            const changeIcon = data.change >= 0 ? 'fa-arrow-up' : 'fa-arrow-down';
            const isLightMode = document.documentElement.classList.contains('light-mode');
            
            card.className = `stock-card ${changeClass} glass-card p-4 cursor-pointer hover:shadow-lg transition-all duration-300`;
            card.innerHTML = `
                <div class="flex justify-between items-start mb-3">
                    <div>
                        <h4 class="font-semibold ${isLightMode ? 'text-slate-800' : 'text-white'}">${data.companyName}</h4>
                        <p class="text-sm ${isLightMode ? 'text-gray-600' : 'text-gray-400'}">${data.symbol}</p>
                    </div>
                    <button class="remove-watchlist ${isLightMode ? 'text-gray-600' : 'text-gray-400'} hover:text-red-400 transition-colors">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="flex justify-between items-end">
                    <span class="text-lg font-bold ${isLightMode ? 'text-slate-800' : 'text-white'}">${data.price.toFixed(2)}</span>
                    <div class="text-right">
                        <div class="text-sm font-medium ${changeClass}">
                            <i class="fas ${changeIcon} mr-1"></i>
                            ${data.change >= 0 ? '+' : ''}${data.change.toFixed(2)}
                        </div>
                        <div class="text-xs ${changeClass}">
                            ${data.changePercent >= 0 ? '+' : ''}${data.changePercent.toFixed(2)}%
                        </div>
                    </div>
                </div>
            `;
            
            // Add click handler for the card
            card.addEventListener('click', function(e) {
                if (!e.target.closest('.remove-watchlist')) {
                    updateMainStock(data.symbol);
                }
            });
            
            // Add remove handler
            const removeBtn = card.querySelector('.remove-watchlist');
            removeBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                watchlist = watchlist.filter(s => s !== data.symbol);
                updateWatchlist();
            });
            
            return card;
        }

        // Markets section functions
        function loadMarketsSection() {
            loadMarketNews();
            loadTopCompanies();
            loadMarketHistory();
        }

        function loadMarketNews() {
            const container = document.getElementById('marketNewsContainer');
            container.innerHTML = '';

            // Extended market news
            const marketNews = [
                ...mockNews,
                {
                    title: "Global Markets Rally as Inflation Concerns Ease",
                    source: "Financial Times",
                    time: "1 hour ago",
                    category: "Markets",
                    url: "https://ft.com/markets-rally"
                },
                {
                    title: "Cryptocurrency Market Shows Signs of Recovery",
                    source: "CoinDesk",
                    time: "3 hours ago",
                    category: "Crypto",
                    url: "https://coindesk.com/crypto-recovery"
                },
                {
                    title: "European Central Bank Maintains Current Interest Rates",
                    source: "Reuters",
                    time: "5 hours ago",
                    category: "Economy",
                    url: "https://reuters.com/ecb-rates"
                }
            ];

            marketNews.forEach(news => {
                const newsItem = createNewsItem(news);
                container.appendChild(newsItem);
            });
        }

        function loadTopCompanies() {
            const container = document.getElementById('topCompaniesContainer');
            container.innerHTML = '';
            const isLightMode = document.documentElement.classList.contains('light-mode');

            topCompanies.forEach((company, index) => {
                const companyCard = document.createElement('div');
                const changeClass = company.change.startsWith('+') ? 'text-green-400' : 'text-red-400';
                
                companyCard.className = 'glass-card p-3 rounded-lg hover:bg-slate-700 transition-colors duration-300 cursor-pointer';
                companyCard.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-amber-500 rounded-full flex items-center justify-center text-white font-bold text-sm mr-3">
                                ${index + 1}
                            </div>
                            <div>
                                <div class="font-semibold ${isLightMode ? 'text-slate-800' : 'text-white'} text-sm">${company.name}</div>
                                <div class="text-xs ${isLightMode ? 'text-gray-600' : 'text-gray-400'}">${company.symbol}</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold ${isLightMode ? 'text-slate-800' : 'text-white'} text-sm">${company.marketCap}</div>
                            <div class="text-xs ${changeClass}">${company.change}</div>
                        </div>
                    </div>
                `;
                
                // Add click handler to load the stock data when clicked
                companyCard.addEventListener('click', () => {
                    updateMainStock(company.symbol);
                    // Switch to dashboard section to show the stock
                    document.querySelectorAll('.section-tab').forEach(tab => tab.classList.remove('active'));
                    document.querySelector('[data-section="dashboard"]').classList.add('active');
                    document.querySelectorAll('.section').forEach(section => section.classList.add('section-hidden'));
                    document.getElementById('dashboard-section').classList.remove('section-hidden');
                    currentSection = 'dashboard';
                });
                
                container.appendChild(companyCard);
            });
        }

        function loadMarketHistory() {
            const container = document.getElementById('marketHistoryContainer');
            container.innerHTML = '';
            const isLightMode = document.documentElement.classList.contains('light-mode');

            marketFacts.forEach(fact => {
                const factCard = document.createElement('div');
                factCard.className = 'glass-card p-4 rounded-lg hover:bg-slate-700 transition-colors duration-300';
                factCard.innerHTML = `
                    <div class="text-center mb-3">
                        <div class="text-2xl font-bold text-amber-400">${fact.year}</div>
                    </div>
                    <h4 class="font-semibold ${isLightMode ? 'text-slate-800' : 'text-white'} mb-2">${fact.title}</h4>
                    <p class="text-sm ${isLightMode ? 'text-gray-700' : 'text-gray-300'}">${fact.description}</p>
                `;
                
                container.appendChild(factCard);
            });
        }

        // Comparison section functions
        function loadComparisonSection() {
            updateComparisonStock(compSymbol1, 1);
            updateComparisonStock(compSymbol2, 2);
            updateComparisonTable();
        }

        // Function to search for a company by name or symbol and update the comparison stock
        function searchAndUpdateComparisonStock(input, chartIndex) {
            // First check if input is a valid symbol
            const symbolMatch = globalCompanies.find(company => 
                company.symbol.toUpperCase() === input.toUpperCase()
            );
            
            if (symbolMatch) {
                // Direct symbol match found
                validateAndUpdateComparisonStock(symbolMatch.symbol, chartIndex);
                return;
            }
            
            // Check if input is a company name
            const nameMatches = globalCompanies.filter(company => 
                company.name.toLowerCase().includes(input.toLowerCase())
            );
            
            if (nameMatches.length > 0) {
                // Use the first matching company
                validateAndUpdateComparisonStock(nameMatches[0].symbol, chartIndex);
                return;
            }
            
            // If no matches found in our database, try Alpha Vantage API
            validateStockSymbolForComparison(input.toUpperCase(), chartIndex);
        }
        
        // Function to validate and update comparison stock
        function validateAndUpdateComparisonStock(symbol, chartIndex) {
            // Add to valid symbols set if not already there
            if (!validStockSymbols.has(symbol)) {
                validStockSymbols.add(symbol);
                
                // Find company info from global companies
                const companyInfo = globalCompanies.find(company => company.symbol === symbol);
                
                // Add to stockInfo if not exists
                if (!stockInfo[symbol]) {
                    stockInfo[symbol] = {
                        name: companyInfo ? companyInfo.name : `${symbol} Inc.`,
                        basePrice: 100 + Math.random() * 200,
                        marketCap: Math.random() * 1e12,
                        volume: Math.random() * 10000000
                    };
                }
            }
            
            // Update the comparison stock
            updateComparisonStock(symbol, chartIndex);
        }
        
        // Function to validate stock symbol for comparison
        async function validateStockSymbolForComparison(symbol, chartIndex) {
            try {
                const response = await fetch(`https://www.alphavantage.co/query?function=SYMBOL_SEARCH&keywords=${symbol}&apikey=${ALPHA_VANTAGE_API_KEY}`);
                const data = await response.json();
                
                if (data.bestMatches && data.bestMatches.length > 0) {
                    // Found a valid symbol
                    const match = data.bestMatches[0];
                    const validSymbol = match['1. symbol'];
                    const name = match['2. name'];
                    
                    // Add to valid symbols set
                    validStockSymbols.add(validSymbol);
                    
                    // Add to stockInfo if not exists
                    if (!stockInfo[validSymbol]) {
                        stockInfo[validSymbol] = {
                            name: name,
                            basePrice: 100 + Math.random() * 200,
                            marketCap: Math.random() * 1e12,
                            volume: Math.random() * 10000000
                        };
                    }
                    
                    // Add to global companies if not exists
                    if (!globalCompanies.some(company => company.symbol === validSymbol)) {
                        globalCompanies.push({
                            symbol: validSymbol,
                            name: name,
                            exchange: match['4. region'] || 'UNKNOWN'
                        });
                    }
                    
                    // Update the comparison stock
                    updateComparisonStock(validSymbol, chartIndex);
                } else {
                    alert(`Invalid stock symbol or company name: ${symbol}. Please try another search.`);
                }
            } catch (error) {
                console.error('Error validating stock symbol:', error);
                alert(`Error validating stock symbol: ${symbol}. Please try another search.`);
            }
        }

        function updateComparisonStock(symbol, chartIndex) {
            if (chartIndex === 1) {
                compSymbol1 = symbol;
                document.getElementById('compStockSymbol1').textContent = symbol;
                document.getElementById('compTableHeader1').textContent = symbol;
            } else {
                compSymbol2 = symbol;
                document.getElementById('compStockSymbol2').textContent = symbol;
                document.getElementById('compTableHeader2').textContent = symbol;
            }

            const info = stockInfo[symbol] || { basePrice: 100 };
            const change = (Math.random() - 0.5) * 10;
            const changePercent = (change / info.basePrice * 100).toFixed(2);
            const changeClass = change >= 0 ? 'text-green-400' : 'text-red-400';

            document.getElementById(`compPrice${chartIndex}`).textContent = `${info.basePrice.toFixed(2)}`;
            document.getElementById(`compChange${chartIndex}`).textContent = `${changePercent >= 0 ? '+' : ''}${changePercent}%`;
            document.getElementById(`compChange${chartIndex}`).className = `text-sm ${changeClass}`;

            updateComparisonChartData(`comp${chartIndex}`, '1h');
        }

        function updateComparisonChartData(chartId, timeRange) {
            const symbol = chartId === 'comp1' ? compSymbol1 : compSymbol2;
            const chart = chartId === 'comp1' ? compChart1 : compChart2;
            const chartData = generateChartData(symbol, timeRange);
            
            chart.data.labels = chartData.labels;
            chart.data.datasets[0].data = chartData.prices;
            chart.update('none');
        }

        function updateComparisonTable() {
            const info1 = stockInfo[compSymbol1] || { basePrice: 100, marketCap: 1e10, volume: 1000000 };
            const info2 = stockInfo[compSymbol2] || { basePrice: 100, marketCap: 1e10, volume: 1000000 };

            // Update prices
            const priceDiff = ((info2.basePrice - info1.basePrice) / info1.basePrice * 100).toFixed(1);
            document.getElementById('compTablePrice1').textContent = `${info1.basePrice.toFixed(2)}`;
            document.getElementById('compTablePrice2').textContent = `${info2.basePrice.toFixed(2)}`;
            document.getElementById('compTablePriceDiff').textContent = `${priceDiff > 0 ? '+' : ''}${priceDiff}%`;
            document.getElementById('compTablePriceDiff').className = `px-4 py-3 text-sm ${priceDiff > 0 ? 'text-green-400' : 'text-red-400'}`;

            // Update market cap
            const mcapDiff = ((info2.marketCap - info1.marketCap) / info1.marketCap * 100).toFixed(1);
            document.getElementById('compTableMCap1').textContent = formatMarketCap(info1.marketCap);
            document.getElementById('compTableMCap2').textContent = formatMarketCap(info2.marketCap);
            document.getElementById('compTableMCapDiff').textContent = `${mcapDiff > 0 ? '+' : ''}${mcapDiff}%`;
            document.getElementById('compTableMCapDiff').className = `px-4 py-3 text-sm ${mcapDiff > 0 ? 'text-green-400' : 'text-red-400'}`;

            // Update volume
            const volDiff = ((info2.volume - info1.volume) / info1.volume * 100).toFixed(1);
            document.getElementById('compTableVol1').textContent = formatVolume(info1.volume);
            document.getElementById('compTableVol2').textContent = formatVolume(info2.volume);
            document.getElementById('compTableVolDiff').textContent = `${volDiff > 0 ? '+' : ''}${volDiff}%`;
            document.getElementById('compTableVolDiff').className = `px-4 py-3 text-sm ${volDiff > 0 ? 'text-green-400' : 'text-red-400'}`;
        }

        // Portfolio section functions
        function loadPortfolioSection() {
            updatePortfolioDisplay();
            updatePortfolioChart();
        }

        function addToPortfolio(symbol, shares, buyPrice) {
            const existingIndex = portfolio.findIndex(item => item.symbol === symbol);
            
            if (existingIndex >= 0) {
                // Update existing holding
                const existing = portfolio[existingIndex];
                const totalShares = existing.shares + shares;
                const totalCost = (existing.shares * existing.buyPrice) + (shares * buyPrice);
                existing.shares = totalShares;
                existing.buyPrice = totalCost / totalShares; // Average cost
            } else {
                // Add new holding
                portfolio.push({
                    symbol: symbol,
                    shares: shares,
                    buyPrice: buyPrice,
                    companyName: stockInfo[symbol]?.name || `${symbol} Inc.`
                });
            }
            
            updatePortfolioDisplay();
            updatePortfolioChart();
        }

        function removeFromPortfolio(symbol) {
            portfolio = portfolio.filter(item => item.symbol !== symbol);
            updatePortfolioDisplay();
            updatePortfolioChart();
        }

        function updatePortfolioDisplay() {
            const container = document.getElementById('portfolioContainer');
            container.innerHTML = '';

            let totalValue = 0;
            let totalCost = 0;

            portfolio.forEach(holding => {
                const currentPrice = (stockInfo[holding.symbol]?.basePrice || 100) + (Math.random() - 0.5) * 10;
                const currentValue = holding.shares * currentPrice;
                const cost = holding.shares * holding.buyPrice;
                const gainLoss = currentValue - cost;
                const gainLossPercent = (gainLoss / cost) * 100;

                totalValue += currentValue;
                totalCost += cost;

                const holdingCard = createPortfolioCard(holding, currentPrice, gainLoss, gainLossPercent);
                container.appendChild(holdingCard);
            });

            // Update total portfolio value
            const totalGainLoss = totalValue - totalCost;
            const totalGainLossPercent = totalCost > 0 ? (totalGainLoss / totalCost) * 100 : 0;

            document.getElementById('totalPortfolioValue').textContent = `${totalValue.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            
            const changeClass = totalGainLoss >= 0 ? 'text-green-400' : 'text-red-400';
            document.getElementById('totalPortfolioChange').innerHTML = 
                `<span class="${changeClass}">${totalGainLoss >= 0 ? '+' : ''}${Math.abs(totalGainLoss).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} (${totalGainLossPercent.toFixed(2)}%)</span>`;
        }

        function createPortfolioCard(holding, currentPrice, gainLoss, gainLossPercent) {
            const card = document.createElement('div');
            const changeClass = gainLoss >= 0 ? 'text-green-400' : 'text-red-400';
            const borderClass = gainLoss >= 0 ? 'border-green-500' : 'border-red-500';
            
            card.className = `glass-card p-4 rounded-lg border-l-4 ${borderClass} hover:shadow-lg transition-all duration-300`;
            card.innerHTML = `
                <div class="flex justify-between items-start mb-3">
                    <div>
                        <h4 class="font-semibold text-white">${holding.companyName}</h4>
                        <p class="text-sm text-gray-400">${holding.symbol} â¢ ${holding.shares} shares</p>
                    </div>
                    <button class="remove-portfolio text-gray-400 hover:text-red-400 transition-colors" data-symbol="${holding.symbol}">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
                <div class="grid grid-cols-2 gap-2 text-sm mb-3">
                    <div>
                        <span class="text-gray-400">Buy Price:</span>
                        <div class="font-semibold text-white">${holding.buyPrice.toFixed(2)}</div>
                    </div>
                    <div>
                        <span class="text-gray-400">Current:</span>
                        <div class="font-semibold text-white">${currentPrice.toFixed(2)}</div>
                    </div>
                </div>
                <div class="flex justify-between items-end">
                    <div>
                        <span class="text-gray-400 text-xs">Current Value</span>
                        <div class="font-bold text-white">${(holding.shares * currentPrice).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                    </div>
                    <div class="text-right">
                        <div class="font-semibold ${changeClass}">
                            ${gainLoss >= 0 ? '+' : ''}${Math.abs(gainLoss).toFixed(2)}
                        </div>
                        <div class="text-xs ${changeClass}">
                            ${gainLossPercent >= 0 ? '+' : ''}${gainLossPercent.toFixed(2)}%
                        </div>
                    </div>
                </div>
            `;

            // Add remove handler
            const removeBtn = card.querySelector('.remove-portfolio');
            removeBtn.addEventListener('click', function() {
                removeFromPortfolio(this.dataset.symbol);
            });

            return card;
        }

        function updatePortfolioChart() {
            // Generate mock portfolio performance data
            const labels = [];
            const data = [];
            const baseValue = portfolio.reduce((sum, holding) => sum + (holding.shares * holding.buyPrice), 0);
            
            for (let i = 30; i >= 0; i--) {
                const date = new Date(Date.now() - i * 24 * 60 * 60 * 1000);
                labels.push(date.toLocaleDateString([], { month: 'short', day: 'numeric' }));
                
                const fluctuation = 1 + (Math.random() - 0.5) * 0.1; // Â±5% daily fluctuation
                const value = baseValue * fluctuation * (1 + (30 - i) * 0.01); // Growth trend
                data.push(value);
            }

            portfolioChart.data.labels = labels;
            portfolioChart.data.datasets[0].data = data;
            portfolioChart.update('none');
        }

        // Utility functions
        function generateChartData(symbol, timeRange) {
            const info = stockInfo[symbol] || { basePrice: 100 };
            let dataPoints, labels = [], prices = [];
            
            switch (timeRange) {
                case '1h':
                    dataPoints = 12;
                    for (let i = dataPoints; i >= 0; i--) {
                        const time = new Date(Date.now() - i * 5 * 60000);
                        labels.push(time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }));
                    }
                    break;
                case '1d':
                    dataPoints = 24;
                    for (let i = dataPoints; i >= 0; i--) {
                        const time = new Date(Date.now() - i * 60 * 60000);
                        labels.push(time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }));
                    }
                    break;
                case '1w':
                    dataPoints = 7;
                    for (let i = dataPoints; i >= 0; i--) {
                        const time = new Date(Date.now() - i * 24 * 60 * 60000);
                        labels.push(time.toLocaleDateString([], { month: 'short', day: 'numeric' }));
                    }
                    break;
                case '1m':
                    dataPoints = 30;
                    for (let i = dataPoints; i >= 0; i--) {
                        const time = new Date(Date.now() - i * 24 * 60 * 60000);
                        labels.push(time.toLocaleDateString([], { month: 'short', day: 'numeric' }));
                    }
                    break;
                case '6m':
                case '1y':
                    dataPoints = timeRange === '6m' ? 26 : 52;
                    for (let i = dataPoints; i >= 0; i--) {
                        const time = new Date(Date.now() - i * 7 * 24 * 60 * 60000);
                        labels.push(time.toLocaleDateString([], { month: 'short', day: 'numeric' }));
                    }
                    break;
                default:
                    dataPoints = 12;
            }
            
            // Generate price data with realistic fluctuations
            let basePrice = info.basePrice;
            for (let i = 0; i <= dataPoints; i++) {
                const volatility = 0.02; // 2% max change
                const change = (Math.random() - 0.5) * 2 * volatility;
                basePrice *= (1 + change);
                prices.push(parseFloat(basePrice.toFixed(2)));
            }
            
            return { labels, prices };
        }

        function generateMockStockData(symbol) {
            const info = stockInfo[symbol] || { 
                name: `${symbol} Inc.`, 
                basePrice: 100 + Math.random() * 200, 
                marketCap: 1e10 + Math.random() * 1e11, 
                volume: 1000000 + Math.random() * 10000000 
            };

            const randomFactor = 0.02; // 2% max fluctuation
            const priceChange = info.basePrice * (Math.random() * randomFactor * 2 - randomFactor);
            const price = info.basePrice + priceChange;
            const changePercent = (priceChange / info.basePrice) * 100;

            return {
                symbol: symbol,
                companyName: info.name,
                price: price,
                change: priceChange,
                changePercent: changePercent,
                volume: info.volume,
                marketCap: info.marketCap
            };
        }

        function formatMarketCap(marketCap) {
            if (marketCap >= 1e12) {
                return `${(marketCap / 1e12).toFixed(1)}T`;
            } else if (marketCap >= 1e9) {
                return `${(marketCap / 1e9).toFixed(1)}B`;
            } else if (marketCap >= 1e6) {
                return `${(marketCap / 1e6).toFixed(1)}M`;
            } else {
                return `${marketCap.toFixed(0)}`;
            }
        }

        function formatVolume(volume) {
            if (volume >= 1e6) {
                return `${(volume / 1e6).toFixed(1)}M`;
            } else if (volume >= 1e3) {
                return `${(volume / 1e3).toFixed(1)}K`;
            } else {
                return volume.toString();
            }
        }

        // Error handling
        window.addEventListener('error', function(event) {
            console.error('Uncaught error:', event.error);
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            // Cleanup any intervals or listeners
        });
    </script>
</body>
</html>
